
<%

if ( PARAMS.errmsg ) {%> 
  <pre style="margin:10px;"> Error: ${PARAMS.errmsg} </pre>
<%} else if (PARAMS._status && PARAMS._status > 0) {%>
  <pre style="margin:10px;"> Error: ${PARAMS._message} </pre>
<%}%>

<% 
def m = [:]; 
def numsvc = null; 
boolean pass = false; 
try { 
  numsvc = SERVICE.lookup("NumberService", "default"); 

  def bill = PARAMS.bill; 
  if ( bill == null ) bill = [:]; 
  if ( bill.amount == null ) bill.amount = 0.00; 

  def info = bill.info; 
  if ( info == null ) info = [:]; 

  m.txntype = 'bpls'; 
  m.orgcode = PARAMS.info?.id; 
  m.refno = PARAMS.appno.toString().toUpperCase();
  m.hashkey = com.rameses.util.Encoder.MD5.encode((m.txntype + m.orgcode + m.refno), m.refno); 

  def paths = REQUEST.pathInfo.toString().split('/'); 
  m.ctxname = (paths.length > 1 ? paths[1] : ''); 

  def appyear = ""; 
  if ( info.appdate ) { 
    appyear = info.appdate.toString().split('-')[0]; 
  } 

  def billperiod = ""; 
  if ( PARAMS.qtr ) { 
    billperiod = appyear +"-Q"+ PARAMS.qtr; 
  } else { 
    billperiod = 'FULL YEAR';  
  } 

  m.billperiod = billperiod; 
  m.expirydatestr = ""; 
  if ( info?.expirydate instanceof java.util.Date ) {
    m.expirydatestr = new java.text.SimpleDateFormat("MMM dd, yyyy").format( info.expirydate ).toUpperCase(); 
  } 
  
  def querySvc = SERVICE.lookup( "QueryService" ); 
  m.ppo = querySvc.findFirst([_schemaname:'payment_partner_option', findBy:[partnerid: m.orgcode]]); 

  def fieldconf = querySvc.findFirst([_schemaname:'gdx_partner_field_conf', findBy:[partnerid: m.orgcode, txntype: m.txntype]]);  
  m.excludefield = fieldconf?.exclude.toString();

  m.bill = bill; 
  m.info = info; 
  pass = true; 

} catch(Throwable t) {
  def errmsg = t.message; 
  if ( !errmsg ) {
    def cause = t.cause; 
    while ( cause != null ) {
      errmsg = cause.message; 
      if ( errmsg ) break; 
    }
  }

  m.errmsg = errmsg; 
  t.printStackTrace();   
}

def escapeHtml = { o-> 
  if ( o ) {
    return org.apache.commons.lang.StringEscapeUtils.escapeHtml( o.toString() ); 
  } else {
    return o;
  }
}

%>
<% if (!pass) {%>
  <pre style="margin:10px;">${m.errmsg.toString()}</pre>

<% } else { %> 

                                 
<div class="row">
    <div class="col-xs-12">
      <div class="row page-header">
        <div class="col-md-6">
           <h2>
              <STRONG>BIN: ${m.info.bin}</STRONG>
          </h2>
        </div>
        <div class="col-md-6">
           <h2>
              <strong>Date Filed: ${m.info.appdate}</strong>
          </h2>
        </div>
      </div>
    </div>
</div>

<div class="row invoice-info">
  <div class="col-md-6">
            <form action="#" method="post" id="paymentOption">
                <div class="row">
                  <div class="col-md-3 col-xs-4"><STRONG>Trade Name</STRONG><span class="pull-right">:</span></div>
                  <div class="col-sm-8 nopadleft"> ${escapeHtml(m.info.tradename)} </div>
                </div>

                <% if (!"ownername".matches(m.excludefield)) { %> 
                <div class="row">
                  <div class="col-md-3 col-xs-4  "><STRONG>Owner Name</STRONG> <span class="pull-right">:</span></div>
                  <div class="col-sm-8 nopadleft" > ${escapeHtml(m.info.ownername)} </div>
                </div>
                <% } %> 
                
                <div class="row">
                  <div class="col-md-3 col-xs-4  "><STRONG>Application</STRONG><span class="pull-right">:</span> </div>
                  <div class="col-sm-8 nopadleft">
                    ${m.info.apptype}
                  </div>
                </div>
            </form>
      </div>
      <div class="col-md-6">
            <form action="#" method="post" id="paymentOption">
                <div class="row">
                  <div class="col-md-2 col-xs-4"><STRONG>Address</STRONG><span class="pull-right">:</span></div>
                  <div class="col-sm-8 nopadleft"> ${escapeHtml(m.info.address)} </div>
                </div>
            </form>
      </div>   
</div>


<div class="row">
    <div class="col-md-12">
       <table class="table">
          <thead>
            <tr>
              <th align="left">Line of Business</th>
              <th align="left">Tax/Fee</th>
              <th class="text-right">Amount</th>
              <th class="text-right">Discount</th>
              <th class="text-right">Surcharge</th>
              <th class="text-right">Interest</th>
              <th class="text-right">Total</th>
            </tr>
          </thead>
          <tbody>
            <% m.info.items?.each{k->%>
            <tr>
              <td>${k.lobname? k.lobname : ''}</td>
              <td>${k.account}</td>
              <td align="right">${numsvc.format('#,##0.00',k.amount)}</td>
              <td align="right">${numsvc.format('#,##0.00',k.discount)}</td>
              <td align="right">${numsvc.format('#,##0.00',k.surcharge)}</td>
              <td align="right">${numsvc.format('#,##0.00',k.interest)}</td>
              <td align="right">${numsvc.format('#,##0.00',k.total)}</td>
            </tr>
            <%}%>
          </tbody>
          <thead>
            <tr>
              <th align="left" colspan="3"><span style="color:red">Note:</span> THIS BILL IS VALID UNTIL ${m.expirydatestr}</th>
              <th class="text-right" colspan="2"> BILL AMOUNT :</th>
              <th class="text-right" colspan="2">P ${m.bill.amount ? numsvc.format('#,##0.00', m.bill.amount) : "0.00"}</th>
            </tr>
            <tr>
              <th align="left" colspan="7">BILL PERIOD : &nbsp;&nbsp;&nbsp;${m.billperiod}</th> 
            </tr> 
            
          </thead>
        </table>
    </div>
</div>

<br>
<div class="row no-print">
    <div class="col-xs-12">

        <% if ( m.bill.amount > 0 ) {%>
          <button class="btn-response btn btn-default" onClick="window.print()"><i class="fa fa-print"></i> Print</button>
        <% } %> 

        <% if ( m.ppo?.objid && m.bill.amount > 0 ) {%>
         
          <button r:context="bill" r:name="pay" class="btn-response btn btn-primary pull-right"><i class="fa fa-credit-card"></i> Pay Now</button>
          <form id="payform" method="post" action="/${m.ctxname}/${PARAMS.name}/createpo" style="display:none;"> 
            <input type="hidden" name="successurl" value="/${m.ctxname}/${PARAMS.name}/payoptions"/> 
            <input type="hidden" name="errorurl" value="${REQUEST.pathInfo}?${REQUEST.queryString}"/> 
            <input type="hidden" name="hashkey" value="${m.hashkey}"/> 
            <input type="hidden" name="txntype" value="${m.txntype}"/> 
            <input type="hidden" name="orgcode" value="${m.orgcode}"/> 
            <input type="hidden" name="refno" value="${m.refno}"/> 
            <% if ( PARAMS.qtr ) { %> 
              <input type="hidden" name="qtr" value="${PARAMS.qtr}"/> 
            <% } %> 
          </form> 

        <% } %> 

        <% if ( m.info.apptype.toString().toUpperCase() == 'RENEW') { %>
          <button r:context="bill" r:name="chooseQtr" class=" btn-response btn btn-success pull-right" style="margin-right: 5px;"> Pay Option</button>
        <% } %>

    </div>
</div>
                 
     



<script>
  \$register( {id:'popup', page:'/payquarter', context:'payqtr', title:'Select Pay Option' }  );
  
  \$put("bill", new function() {
    this.chooseQtr = function() {
        var handler = function(x) {
          var str = window.location+"";
          var idx = str.indexOf("&qtr");
          if( idx > 0 ) {
            str = str.substr(0, idx);
          }
          location.href = str + "&qtr=" + x ;
        }
        return new PopupOpener( "popup", {callbackHandler: handler} ); 
    }
   
    this.chooseFullPayment = function() {
      var str = window.location+"";
      var idx = str.indexOf("&qtr"); 
      if( idx > 0 ) {
        str = str.substr(0, idx);
      }
      location.href = str ;
    }

    this.pay = function() { 
      \$('#payform').submit(); 
    }       

    this.cancelPaymentOrder = function() { 
      \$('#cancelpayform').submit(); 
    } 
   }
  );   
</script>

<% } %> 
